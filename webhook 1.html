<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Client ðŸš€</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- GSAP for Animations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <!-- Custom Styles & Tailwind Config -->
    <style>
        /* Basic Style Resets & Font Family */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568; /* gray-600 */
            border-radius: 4px;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #718096; /* gray-500 */
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #2d3748; /* gray-800 */
        }

        /* Styles for Monaco Editor (if you were to add it) or CodeMirror-like textareas */
        .code-font {
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
        }
        
        /* Animation for spinning icon */
        .spinning {
            animation: spin 1.5s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Breathing animation for the webhook pill */
        .breathing {
            animation: breathe 2.5s ease-in-out infinite;
        }
        @keyframes breathe {
          0%, 100% { box-shadow: 0 0 2px 0px rgba(59, 130, 246, 0.4); }
          50% { box-shadow: 0 0 10px 3px rgba(59, 130, 246, 0.7); }
        }
    </style>
    <script>
        // Custom Tailwind CSS Configuration
        tailwind.config = {
            darkMode: 'class', // Enable dark mode using a class
            theme: {
                extend: {
                    colors: {
                        // Light Mode Palette
                        'primary': {
                            '50': '#eff6ff', '100': '#dbeafe', '200': '#bfdbfe', '300': '#93c5fd',
                            '400': '#60a5fa', '500': '#3b82f6', '600': '#2563eb', '700': '#1d4ed8',
                            '800': '#1e40af', '900': '#1e3a8a', '950': '#172554'
                        },
                        'light-bg': '#f8fafc', // slate-50
                        'light-surface': '#ffffff',
                        'light-muted': '#64748b', // slate-500
                        'light-border': '#e2e8f0', // slate-200
                        // Dark Mode Palette
                        'dark-bg': '#0f172a', // slate-900
                        'dark-surface': '#1e293b', // slate-800
                        'dark-muted': '#94a3b8', // slate-400
                        'dark-border': '#334155', // slate-700
                    },
                    transitionProperty: {
                        'width': 'width',
                        'margin': 'margin-left, margin-right',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-light-bg dark:bg-dark-bg text-slate-800 dark:text-slate-200 antialiased">

    <!-- Main Application Wrapper -->
    <div id="app-wrapper" class="flex h-screen overflow-hidden">

        <!-- History Sidebar -->
        <aside id="history-sidebar-container" class="bg-light-surface dark:bg-dark-surface/80 backdrop-blur-sm border-r border-light-border dark:border-dark-border flex-shrink-0 flex flex-col transition-width duration-300 ease-in-out w-80">
            <div class="flex items-center justify-between p-4 border-b border-light-border dark:border-dark-border h-16 flex-shrink-0">
                <div class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-primary-500">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                    </svg>
                    <h2 class="font-bold text-lg">History</h2>
                </div>
                <div>
                    <button id="new-request-btn" title="New Request" class="p-2 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                    </button>
                    <button id="clear-history-btn" title="Clear All History" class="p-2 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg>
                    </button>
                </div>
            </div>
            <div id="history-sidebar" class="flex-grow overflow-y-auto p-2 space-y-1">
                <!-- History items will be injected here -->
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-grow flex flex-col min-w-0">
            <!-- Top Navbar -->
            <header class="flex items-center justify-between p-4 border-b bg-light-surface/80 dark:bg-dark-surface/80 backdrop-blur-sm border-light-border dark:border-dark-border h-16 flex-shrink-0">
                <div class="flex items-center gap-3">
                    <button id="sidebar-toggle-btn" title="Toggle Sidebar" class="p-2 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25H12" /></svg>
                    </button>
                    <h1 class="text-xl font-bold text-slate-900 dark:text-white">API Client</h1>
                </div>

                <div id="webhook-status-pill" class="hidden items-center gap-2 bg-primary-500 text-white text-sm font-semibold px-3 py-1.5 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 11.667 0l3.181-3.183m-4.991-2.691v4.992" /></svg>
                    <span id="webhook-timer"></span>
                    <button id="stop-webhook-btn" class="ml-1 opacity-70 hover:opacity-100">&times;</button>
                </div>

                <div class="flex items-center gap-2">
                    <button id="toggle-theme-btn" class="p-2 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
                        <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.95-4.243-1.59-1.591M5.25 12H3m4.243-4.95L6.343 5.657M12 6.75a5.25 5.25 0 1 0 0 10.5 5.25 5.25 0 0 0 0-10.5Z" /></svg>
                        <svg id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 hidden"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.72 9.72 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 0 0 9.002-5.998Z" /></svg>
                    </button>
                    <button id="open-settings-btn" class="p-2 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.24-.438.613-.43.992a6.759 6.759 0 0 1 0 1.905c.008.379.137.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.6 6.6 0 0 1-.22.128c-.333.183-.582.495-.644.869l-.213 1.28c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.063-.374-.313-.686-.645-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.075-.124l-1.217.456a1.125 1.125 0 0 1-1.37-.49l-1.296-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.759 6.759 0 0 1 0-1.905c-.008-.379-.137-.75-.43-.99l-1.004-.828a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.49l1.217.456c.355.133.75.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.213-1.28Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg>
                    </button>
                </div>
            </header>
            
            <!-- Main scrollable content area -->
            <main id="main-content" class="flex-grow min-h-0 overflow-y-auto p-4 lg:p-6 space-y-6">
                <!-- Request UI -->
                <div class="bg-light-surface dark:bg-dark-surface rounded-xl shadow-sm border border-light-border dark:border-dark-border p-5">
                    <div class="flex flex-col sm:flex-row gap-2">
                        <select id="request-type" class="code-font font-semibold bg-slate-100 dark:bg-slate-700 border-light-border dark:border-slate-600 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition sm:w-32">
                            <option>GET</option><option>POST</option><option>PUT</option><option>DELETE</option><option>PATCH</option>
                        </select>
                        <input type="text" id="url-input" class="flex-grow bg-slate-100 dark:bg-slate-700 border-light-border dark:border-slate-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition code-font" placeholder="Enter URL or Import cURL">
                        <button data-modal-target="curl-modal" data-modal-toggle="curl-modal" class="px-4 py-2 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors flex items-center justify-center gap-2" title="Import from cURL">
                             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" /></svg>
                        </button>
                        <button id="send-button" class="bg-primary-600 text-white font-semibold px-5 py-2 rounded-md hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 dark:focus:ring-offset-dark-bg transition-all duration-200 ease-in-out flex items-center justify-center gap-2 transform hover:scale-105">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5" /></svg>
                            Send
                        </button>
                    </div>
                    <div class="mt-4">
                        <!-- Request Tabs -->
                        <div class="border-b border-light-border dark:border-dark-border">
                            <nav id="request-tab" class="-mb-px flex space-x-4" aria-label="Tabs">
                                <button data-tab-target="#headers-content" class="tab-btn active text-primary-600 dark:text-primary-400 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-primary-500">Headers</button>
                                <button data-tab-target="#body-content" class="tab-btn text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-300 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent">Body</button>
                            </nav>
                        </div>
                        <div class="pt-4">
                            <div id="headers-content" class="tab-pane active space-y-2">
                                <div id="headers-list" class="space-y-2"></div>
                                <button id="add-header-button" class="text-sm font-semibold text-primary-600 hover:text-primary-700 dark:text-primary-400 dark:hover:text-primary-300 flex items-center gap-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5v-4.5Z" /></svg>
                                    Add Header
                                </button>
                            </div>
                            <div id="body-content" class="tab-pane hidden">
                                <textarea id="body-input" class="w-full h-40 bg-slate-100 dark:bg-slate-900/50 border-light-border dark:border-dark-border rounded-md p-3 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition code-font" placeholder="Request body (e.g., JSON)"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Response UI -->
                <div class="bg-light-surface dark:bg-dark-surface rounded-xl shadow-sm border border-light-border dark:border-dark-border flex flex-col min-h-0">
                    <div class="p-4 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 border-b border-light-border dark:border-dark-border flex-shrink-0">
                        <div class="flex items-center gap-4">
                            <h3 class="text-lg font-bold">Response</h3>
                            <div id="status-container"></div>
                        </div>
                        <div id="response-view-switcher" class="flex items-center bg-slate-100 dark:bg-slate-700 p-1 rounded-lg text-sm">
                            <button id="view-json-btn" class="response-view-btn active px-3 py-1 font-semibold rounded-md">JSON</button>
                            <button id="view-cards-btn" class="response-view-btn px-3 py-1 font-semibold rounded-md">Cards</button>
                            <button id="view-table-btn" class="response-view-btn px-3 py-1 font-semibold rounded-md">Table</button>
                        </div>
                    </div>
                    <div class="flex-grow min-h-0">
                        <div class="border-b border-light-border dark:border-dark-border flex-shrink-0">
                            <nav id="response-details-tab" class="flex space-x-4 px-4" aria-label="Tabs">
                                <button data-tab-target="#response-body-content" class="tab-btn active text-primary-600 dark:text-primary-400 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-primary-500">Body</button>
                                <button data-tab-target="#response-metrics-content" class="tab-btn text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-300 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent">Metrics</button>
                            </nav>
                        </div>
                        <div class="p-4 overflow-y-auto">
                            <div id="response-body-content" class="tab-pane active">
                                <pre id="json-response" class="code-font bg-slate-100 dark:bg-slate-900/50 p-4 rounded-lg text-sm overflow-auto max-h-[100vh]">Your API response will appear here...</pre>
                                <div id="cards-response-container" class="hidden space-y-2 overflow-y-auto max-h-[40vh]"></div>
                                <div id="table-response-container" class="hidden overflow-auto max-h-[40vh]">
                                    <table class="w-full text-sm text-left" id="table-response"></table>
                                </div>
                            </div>
                            <div id="response-metrics-content" class="tab-pane hidden">
                                <div id="metrics-container" class="text-sm space-y-3 p-2"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Settings Offcanvas -->
    <div id="settings-offcanvas" class="fixed top-0 right-0 z-40 h-screen p-4 overflow-y-auto transition-transform translate-x-full bg-light-surface dark:bg-dark-surface w-80 shadow-xl" tabindex="-1">
        <div class="flex items-center justify-between">
            <h5 class="text-base font-semibold uppercase">Webhook Settings</h5>
            <button type="button" data-drawer-hide="settings-offcanvas" class="p-1.5 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700">
                <svg class="w-5 h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/></svg>
            </button>
        </div>
        <div class="py-4 space-y-4">
            <label for="enable-webhook-switch" class="flex items-center cursor-pointer">
                <div class="relative">
                    <input type="checkbox" id="enable-webhook-switch" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary-600"></div>
                </div>
                <span class="ml-3 text-sm font-medium">Enable Webhook on Send</span>
            </label>
            <div id="webhook-options" class="space-y-2">
                <label for="webhook-interval-input" class="text-sm font-medium">Interval (seconds)</label>
                <input type="number" id="webhook-interval-input" value="10" min="2" class="w-full bg-slate-100 dark:bg-slate-700 border-light-border dark:border-slate-600 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition">
                <p class="text-xs text-light-muted dark:text-dark-muted">The request will repeat at this interval for a maximum of 2 minutes.</p>
            </div>
        </div>
    </div>
    <div id="settings-offcanvas-backdrop" class="bg-gray-900/50 dark:bg-gray-900/80 fixed inset-0 z-30 hidden"></div>

    <!-- cURL Import Modal -->
    <div id="curl-modal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-full">
        <div class="relative p-4 w-full max-w-2xl h-full flex items-center">
            <div class="relative bg-light-surface dark:bg-dark-surface rounded-lg shadow-xl w-full">
                <div class="flex items-center justify-between p-4 border-b rounded-t dark:border-gray-600">
                    <h3 class="text-xl font-semibold">Import from cURL</h3>
                    <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" data-modal-hide="curl-modal">
                        <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/></svg>
                    </button>
                </div>
                <div class="p-4 md:p-5 space-y-4">
                    <textarea id="curl-input" class="w-full h-48 bg-slate-100 dark:bg-slate-900/50 border-light-border dark:border-dark-border rounded-md p-3 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition code-font" placeholder="Paste your cURL command here..."></textarea>
                </div>
                <div class="flex items-center p-4 md:p-5 border-t border-gray-200 rounded-b dark:border-gray-600">
                    <button id="modal-import-btn" data-modal-hide="curl-modal" type="button" class="text-white bg-primary-600 hover:bg-primary-700 focus:ring-4 focus:outline-none focus:ring-primary-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-primary-600 dark:hover:bg-primary-700 dark:focus:ring-primary-800">Import</button>
                    <button data-modal-hide="curl-modal" type="button" class="ms-3 text-gray-500 bg-white hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-blue-300 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 focus:z-10 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-500 dark:hover:text-white dark:hover:bg-gray-600 dark:focus:ring-gray-600">Cancel</button>
                </div>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Element References (New Structure) ---
        const urlInput = document.getElementById('url-input');
        const requestTypeSelect = document.getElementById('request-type');
        const sendButton = document.getElementById('send-button');
        const headersList = document.getElementById('headers-list');
        const addHeaderButton = document.getElementById('add-header-button');
        const bodyInput = document.getElementById('body-input');
        const jsonResponseView = document.getElementById('json-response');
        const cardsResponseContainer = document.getElementById('cards-response-container');
        const tableResponseContainer = document.getElementById('table-response-container');
        const statusContainer = document.getElementById('status-container');
        const viewJsonBtn = document.getElementById('view-json-btn');
        const viewCardsBtn = document.getElementById('view-cards-btn');
        const viewTableBtn = document.getElementById('view-table-btn');
        const curlInput = document.getElementById('curl-input');
        const modalImportBtn = document.getElementById('modal-import-btn');
        const historySidebar = document.getElementById('history-sidebar');
        const sidebarContainer = document.getElementById('history-sidebar-container');
        const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
        const clearHistoryBtn = document.getElementById('clear-history-btn');
        const newRequestBtn = document.getElementById('new-request-btn');
        const metricsContainer = document.getElementById('metrics-container');
        const webhookStatusPill = document.getElementById('webhook-status-pill');
        const stopWebhookBtn = document.getElementById('stop-webhook-btn');
        const webhookTimer = document.getElementById('webhook-timer');
        const enableWebhookSwitch = document.getElementById('enable-webhook-switch');
        const webhookIntervalInput = document.getElementById('webhook-interval-input');
        const toggleThemeBtn = document.getElementById('toggle-theme-btn');
        const openSettingsBtn = document.getElementById('open-settings-btn');
        
        // Modal & Drawer Elements
        const curlModal = document.getElementById('curl-modal');
        const settingsOffcanvas = document.getElementById('settings-offcanvas');
        const settingsOffcanvasBackdrop = document.getElementById('settings-offcanvas-backdrop');

        let responseData = null;
        let currentRequestId = null;
        let webhookIntervalId = null;
        let webhookTimeoutId = null;
        let webhookCountdownId = null;
        let isWebhookEnabled = false;

        // --- GSAP Animations ---
        gsap.from("#main-content > div", {
            duration: 0.5,
            y: 20,
            opacity: 0,
            stagger: 0.1,
            ease: "power2.out",
            delay: 0.2
        });

        // --- Theme Toggle ---
        const themeIconLight = document.getElementById('theme-icon-light');
        const themeIconDark = document.getElementById('theme-icon-dark');
        const setTheme = (theme) => {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                themeIconLight.classList.add('hidden');
                themeIconDark.classList.remove('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                themeIconLight.classList.remove('hidden');
                themeIconDark.classList.add('hidden');
            }
            localStorage.setItem('apiClientTheme', theme);
        };
        toggleThemeBtn.addEventListener('click', () => {
            const currentTheme = localStorage.getItem('apiClientTheme');
            setTheme(currentTheme === 'dark' ? 'light' : 'dark');
        });
        const savedTheme = localStorage.getItem('apiClientTheme');
        if (savedTheme) {
            setTheme(savedTheme);
        } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
            setTheme('dark');
        }

        // --- UI & Visualization Functions ---
        const createHeaderInput = (key = '', value = '') => {
            const row = document.createElement('div');
            row.className = 'flex items-center gap-2 header-item';
            row.innerHTML = `
                <input type="text" class="header-key flex-grow bg-slate-100 dark:bg-slate-700 border-light-border dark:border-slate-600 rounded-md px-3 py-1.5 text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition" placeholder="Key" value="${key}">
                <input type="text" class="header-value flex-grow bg-slate-100 dark:bg-slate-700 border-light-border dark:border-slate-600 rounded-md px-3 py-1.5 text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition" placeholder="Value" value="${value}">
                <button class="remove-header-btn p-2 rounded-md text-slate-400 hover:bg-red-100 hover:text-red-600 dark:hover:bg-red-900/50 dark:hover:text-red-400 transition-colors" type="button">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 0 0 6 3.75v.443c-.795.077-1.58.22-2.365.468a.75.75 0 1 0 .53 1.402c.794-.248 1.57-.394 2.335-.464v1.162a1 1 0 0 0 .75.97l.01.005a1 1 0 0 0 .74-.97V5.66c.765.07 1.54.216 2.335.464a.75.75 0 1 0 .53-1.402c-.785-.248-1.57-.391-2.365-.468v-.443A2.75 2.75 0 0 0 8.75 1ZM3.5 8.75c0-.69.56-1.25 1.25-1.25h6.5c.69 0 1.25.56 1.25 1.25v6.5c0 .69-.56 1.25-1.25 1.25h-6.5c-.69 0-1.25-.56-1.25-1.25v-6.5Zm3.5 1a.75.75 0 0 0-1.5 0v4.5a.75.75 0 0 0 1.5 0v-4.5Zm4-1.5a.75.75 0 0 1 .75.75v4.5a.75.75 0 0 1-1.5 0v-4.5a.75.75 0 0 1 .75-.75Z" clip-rule="evenodd" /></svg>
                </button>`;
            headersList.appendChild(row);
            gsap.from(row, { duration: 0.3, opacity: 0, y: -10, ease: "power2.out" });
            row.querySelector('.remove-header-btn').addEventListener('click', () => {
                gsap.to(row, { duration: 0.3, opacity: 0, x: 20, ease: "power2.in", onComplete: () => row.remove() });
            });
        };

        const displayStatus = (status, ok) => {
            const statusClass = ok ? 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300' : 'bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300';
            statusContainer.innerHTML = `<span class="px-2.5 py-1 text-sm font-semibold rounded-full ${statusClass}">Status: ${status}</span>`;
        };

        const switchView = (view) => {
            [jsonResponseView, cardsResponseContainer, tableResponseContainer].forEach(v => v.classList.add('hidden'));
            document.querySelectorAll('.response-view-btn').forEach(b => b.classList.remove('active', 'bg-white', 'dark:bg-slate-800', 'text-slate-900', 'dark:text-white'));
            
            const btn = document.getElementById(`view-${view}-btn`);
            btn.classList.add('active', 'bg-white', 'dark:bg-slate-800', 'text-slate-900', 'dark:text-white');

            if (view === 'json') { jsonResponseView.classList.remove('hidden'); } 
            else if (view === 'cards') { cardsResponseContainer.classList.remove('hidden'); if (responseData) renderCards(responseData); }
            else if (view === 'table') { tableResponseContainer.classList.remove('hidden'); if (responseData) renderTable(responseData); }
        };

        const renderTable = (data) => {
            const tableEl = document.getElementById('table-response');
            tableEl.innerHTML = '';
            if (!Array.isArray(data) || data.length === 0) {
                tableEl.innerHTML = '<thead class="text-xs text-slate-700 uppercase bg-slate-50 dark:bg-slate-700 dark:text-slate-400"><tr><th class="px-6 py-3">Info</th></tr></thead><tbody><tr class="bg-white border-b dark:bg-slate-800 dark:border-slate-700"><td class="px-6 py-4">Data is not an array or is empty.</td></tr></tbody>';
                return;
            }
            const headers = Object.keys(data[0]);
            const thead = document.createElement('thead');
            thead.className = "text-xs text-slate-700 uppercase bg-slate-50 dark:bg-slate-700 dark:text-slate-400 sticky top-0";
            thead.innerHTML = `<tr>${headers.map(h => `<th scope="col" class="px-6 py-3">${h}</th>`).join('')}</tr>`;
            const tbody = document.createElement('tbody');
            tbody.innerHTML = data.map(obj => `<tr class="bg-white border-b dark:bg-slate-800 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-600">${headers.map(h => `<td class="px-6 py-4">${typeof obj[h] === 'object' ? JSON.stringify(obj[h]) : obj[h]}</td>`).join('')}</tr>`).join('');
            tableEl.append(thead, tbody);
        };
        
        const renderCards = (data) => {
            cardsResponseContainer.innerHTML = '';
            const dataArray = Array.isArray(data) ? data : [data];
            if (dataArray.length === 0 || (dataArray[0] && Object.keys(dataArray[0]).length === 0)) {
                cardsResponseContainer.innerHTML = '<p class="text-light-muted dark:text-dark-muted">No data to display in card view.</p>';
                return;
            }
            dataArray.forEach((item, index) => {
                const itemId = `card-item-${index}`;
                const title = item.name || item.title || item.id || `Item ${index + 1}`;
                const card = document.createElement('div');
                card.className = "bg-slate-100 dark:bg-slate-900/50 rounded-lg";
                card.innerHTML = `
                    <h2>
                        <button type="button" class="flex items-center justify-between w-full p-4 font-medium text-left" data-accordion-target="#${itemId}">
                            <span>${title}</span>
                            <svg data-accordion-icon class="w-3 h-3 rotate-180 shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5 5 1 1 5"/></svg>
                        </button>
                    </h2>
                    <div id="${itemId}" class="hidden p-4 border-t border-light-border dark:border-dark-border">
                        <pre class="code-font text-sm"><code>${JSON.stringify(item, null, 2)}</code></pre>
                    </div>`;
                cardsResponseContainer.appendChild(card);
                const button = card.querySelector('button');
                const content = card.querySelector(`#${itemId}`);
                const icon = card.querySelector('[data-accordion-icon]');
                button.addEventListener('click', () => {
                    content.classList.toggle('hidden');
                    icon.classList.toggle('rotate-180');
                });
            });
        };

        const renderMetrics = (response, responseBody, duration) => {
            metricsContainer.innerHTML = '';
            const headers = response.headers;

            const createMetricRow = (label, value) => {
                if (value === null || value === undefined || value === '') return '';
                return `
                    <div class="grid grid-cols-3 gap-4">
                        <dt class="font-medium text-light-muted dark:text-dark-muted">${label}</dt>
                        <dd class="col-span-2 font-mono text-slate-700 dark:text-slate-300">${value}</dd>
                    </div>`;
            };
            
            let metricsHTML = '<dl class="space-y-3">';
            metricsHTML += createMetricRow('Status Code', response.status);
            metricsHTML += createMetricRow('Response Time', `${duration} ms`);
            metricsHTML += createMetricRow('Content-Type', headers.get('content-type'));
            metricsHTML += createMetricRow('Content-Length', headers.get('content-length') ? `${headers.get('content-length')} bytes` : null);
            metricsHTML += createMetricRow('Cache-Control', headers.get('cache-control'));
            metricsHTML += createMetricRow('ETag', headers.get('etag'));
            metricsHTML += createMetricRow('Last-Modified', headers.get('last-modified'));
            metricsHTML += createMetricRow('Server', headers.get('server'));
            metricsHTML += createMetricRow('X-Powered-By', headers.get('x-powered-by'));
            metricsHTML += createMetricRow('X-Request-ID', headers.get('x-request-id') || headers.get('x-correlation-id'));
            metricsHTML += createMetricRow('X-API-Version', headers.get('x-api-version'));
            metricsHTML += createMetricRow('Deprecation', headers.get('deprecation'));
            
            // Rate Limiting
            const rateLimit = headers.get('x-ratelimit-limit');
            if (rateLimit) {
                metricsHTML += createMetricRow('Rate Limit', `${headers.get('x-ratelimit-remaining')} / ${rateLimit}`);
                const resetTime = headers.get('x-ratelimit-reset');
                if(resetTime) {
                    const resetDate = new Date(resetTime * 1000);
                    metricsHTML += createMetricRow('Rate Limit Reset', resetDate.toLocaleTimeString());
                }
            }

            metricsHTML += createMetricRow('Retry-After', headers.get('retry-after'));

            // Authorization & Errors from body
            if (response.status === 401 || response.status === 403) {
                 metricsHTML += createMetricRow('Authorization', 'Failed (401/403)');
            }
            if (responseBody && responseBody.error) {
                metricsHTML += createMetricRow('Error Message', responseBody.error.message || JSON.stringify(responseBody.error));
            } else if (responseBody && responseBody.message && !response.ok) {
                metricsHTML += createMetricRow('Error Message', responseBody.message);
            }
            
            if (responseBody && responseBody.token_expires_in) {
                 metricsHTML += createMetricRow('Token Expires In', `${responseBody.token_expires_in} seconds`);
            }

            metricsHTML += '</dl>';
            metricsContainer.innerHTML = metricsHTML;
        };
        
        // --- Tab Switching Logic ---
        document.querySelectorAll('[data-tab-target]').forEach(button => {
            button.addEventListener('click', () => {
                const nav = button.closest('nav');
                const targetSelector = button.dataset.tabTarget;
                const targetPane = document.querySelector(targetSelector);

                // Update button states
                nav.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active', 'text-primary-600', 'dark:text-primary-400', 'border-primary-500');
                    btn.classList.add('text-slate-500', 'dark:text-slate-400', 'border-transparent');
                });
                button.classList.add('active', 'text-primary-600', 'dark:text-primary-400', 'border-primary-500');
                button.classList.remove('text-slate-500', 'dark:text-slate-400', 'border-transparent');

                // Update pane visibility
                targetPane.parentElement.querySelectorAll('.tab-pane').forEach(pane => {
                    pane.classList.remove('active');
                    pane.classList.add('hidden');
                });
                targetPane.classList.add('active');
                targetPane.classList.remove('hidden');
            });
        });

        // --- Modal & Drawer Toggling ---
        const toggleModal = (modalId, show) => {
            const modal = document.getElementById(modalId);
            if (show) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            } else {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        };
        document.querySelectorAll('[data-modal-toggle]').forEach(el => {
            el.addEventListener('click', () => toggleModal(el.dataset.modalTarget, true));
        });
        document.querySelectorAll('[data-modal-hide]').forEach(el => {
            el.addEventListener('click', () => toggleModal(el.closest('.fixed').id, false));
        });

        const toggleDrawer = (show) => {
            if(show) {
                settingsOffcanvas.classList.remove('translate-x-full');
                settingsOffcanvasBackdrop.classList.remove('hidden');
            } else {
                settingsOffcanvas.classList.add('translate-x-full');
                settingsOffcanvasBackdrop.classList.add('hidden');
            }
        };
        openSettingsBtn.addEventListener('click', (e) => {
            e.preventDefault();
            toggleDrawer(true);
        });
        document.querySelector('[data-drawer-hide="settings-offcanvas"]').addEventListener('click', () => toggleDrawer(false));
        settingsOffcanvasBackdrop.addEventListener('click', () => toggleDrawer(false));


        // --- Webhook Logic (Functionality preserved) ---
        const startWebhook = () => {
            const intervalSeconds = parseInt(webhookIntervalInput.value, 10);
            if (!intervalSeconds || intervalSeconds < 2) {
                alert('Interval must be at least 2 seconds.');
                return;
            }
            
            stopWebhook(); 
            sendButton.disabled = true;
            webhookStatusPill.classList.remove('hidden');
            webhookStatusPill.classList.add('flex', 'breathing');
            webhookStatusPill.querySelector('svg').classList.add('spinning');
            
            const durationMs = 120 * 1000;
            let remainingMs = durationMs;

            const updateTimer = () => {
                webhookTimer.textContent = `Stopping in ${Math.ceil(remainingMs / 1000)}s`;
                remainingMs -= 1000;
            };

            sendRequest(true); 
            webhookIntervalId = setInterval(() => sendRequest(true), intervalSeconds * 1000);
            
            updateTimer();
            webhookCountdownId = setInterval(updateTimer, 1000);

            webhookTimeoutId = setTimeout(stopWebhook, durationMs);
        };

        const stopWebhook = () => {
            clearInterval(webhookIntervalId);
            clearTimeout(webhookTimeoutId);
            clearInterval(webhookCountdownId);
            webhookIntervalId = null;
            webhookTimeoutId = null;
            webhookCountdownId = null;
            webhookStatusPill.classList.add('hidden');
            webhookStatusPill.classList.remove('flex', 'breathing');
            const icon = webhookStatusPill.querySelector('svg');
            if(icon) icon.classList.remove('spinning');

            sendButton.disabled = false;
            sendButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5" /></svg> Send`;
        };

        // --- Sidebar & History Logic (Functionality preserved) ---
        sidebarToggleBtn.addEventListener('click', () => {
             sidebarContainer.classList.toggle('w-80');
             sidebarContainer.classList.toggle('w-0');
             sidebarContainer.classList.toggle('p-0');
        });
        
        const getHistory = () => JSON.parse(localStorage.getItem('apiClientHistory') || '[]');
        const saveHistory = (history) => localStorage.setItem('apiClientHistory', JSON.stringify(history));

        const clearHistory = () => {
            if (confirm('Are you sure you want to clear all request history?')) {
                localStorage.removeItem('apiClientHistory');
                renderHistory();
            }
        };

        const addOrUpdateHistory = (request) => {
            let history = getHistory();
            if (request.id && history.some(h => h.id === request.id)) {
                history = history.map(h => h.id === request.id ? request : h);
            } else {
                request.id = crypto.randomUUID();
                history.unshift(request);
            }
            saveHistory(history);
            renderHistory();
            return request.id;
        };

        const deleteRequestFromHistory = (requestId) => {
            let history = getHistory();
            history = history.filter(req => req.id !== requestId);
            saveHistory(history);
            renderHistory();
        };

        const renderHistory = () => {
            const history = getHistory();
            historySidebar.innerHTML = '';
            if (history.length === 0) {
                historySidebar.innerHTML = '<div class="p-4 text-center text-sm text-light-muted dark:text-dark-muted">No history yet.</div>';
                return;
            }
            history.forEach(req => {
                const methodColors = {
                    'GET': 'text-green-500', 'POST': 'text-yellow-500', 'PUT': 'text-blue-500',
                    'PATCH': 'text-purple-500', 'DELETE': 'text-red-500'
                };
                const item = document.createElement('div');
                item.className = 'history-item flex items-center gap-2 p-2 rounded-md cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-700/50 transition-colors';
                item.dataset.requestId = req.id;
                item.innerHTML = `
                    <span class="font-bold text-xs w-14 text-center ${methodColors[req.method] || 'text-slate-500'}">${req.method}</span>
                    <span class="url text-sm flex-grow truncate">${req.url}</span>
                    <button class="delete-history-btn p-1 rounded-md text-slate-400 hover:text-red-500 hover:bg-red-100 dark:hover:bg-red-900/50 flex-shrink-0">
                         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4"><path fill-rule="evenodd" d="M5 3.25V4H2.75a.75.75 0 0 0 0 1.5h.3l.815 8.15A1.5 1.5 0 0 0 5.357 15h5.285a1.5 1.5 0 0 0 1.493-1.35l.815-8.15h.3a.75.75 0 0 0 0-1.5H11v-.75A2.25 2.25 0 0 0 8.75 1h-1.5A2.25 2.25 0 0 0 5 3.25Zm2.5-.75a.75.75 0 0 0-.75.75V4h3v-.75a.75.75 0 0 0-.75-.75h-1.5ZM6.5 6.75a.75.75 0 0 0-1.5 0v5.5a.75.75 0 0 0 1.5 0v-5.5Zm3 0a.75.75 0 0 0-1.5 0v5.5a.75.75 0 0 0 1.5 0v-5.5Z" clip-rule="evenodd" /></svg>
                    </button>
                `;
                item.addEventListener('click', (e) => {
                    if (e.target.closest('.delete-history-btn')) return;
                    loadRequestFromHistory(req.id);
                });
                item.querySelector('.delete-history-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteRequestFromHistory(req.id);
                });
                historySidebar.appendChild(item);
            });
        };

        const loadRequestFromHistory = (requestId) => {
            const history = getHistory();
            const request = history.find(req => req.id === requestId);
            if (!request) return;

            currentRequestId = request.id;
            urlInput.value = request.url;
            requestTypeSelect.value = request.method;
            bodyInput.value = request.body;
            headersList.innerHTML = '';
            (request.headers || []).forEach(h => createHeaderInput(h.key, h.value));
            
            document.querySelectorAll('.history-item').forEach(item => item.classList.remove('bg-primary-50', 'dark:bg-primary-900/30'));
            const activeItem = document.querySelector(`.history-item[data-request-id="${requestId}"]`);
            if (activeItem) activeItem.classList.add('bg-primary-50', 'dark:bg-primary-900/30');
        };
        
        const parseCurlCommand = (curlString) => {
            const result = { url: '', method: 'GET', headers: [], body: '' };
            const cleanCurl = curlString.replace(/\\\n/g, ' ').replace(/\n/g, ' ').trim();
            const args = [];
            let currentArg = '', inQuote = null;
            for (let i = 0; i < cleanCurl.length; i++) {
                const char = cleanCurl[i];
                if (inQuote) {
                    if (char === inQuote && cleanCurl[i - 1] !== '\\') inQuote = null;
                    else currentArg += char;
                } else {
                    if (char === "'" || char === '"') inQuote = char;
                    else if (char === ' ') { if (currentArg) { args.push(currentArg); currentArg = ''; } } 
                    else currentArg += char;
                }
            }
            if (currentArg) args.push(currentArg);
            for (let i = 0; i < args.length; i++) {
                const arg = args[i];
                if (arg.startsWith('http')) { if (!result.url) result.url = arg; } 
                else if (arg === '-X' || arg === '--request') { result.method = args[++i].toUpperCase(); } 
                else if (arg === '-H' || arg === '--header') {
                    const header = args[++i];
                    const [key, ...valueParts] = header.split(/:(.*)/s);
                    if (key && valueParts.length > 0) result.headers.push({ key: key.trim(), value: valueParts[0].trim() });
                } else if (arg === '-d' || arg === '--data' || arg === '--data-raw') {
                    result.body = args[++i];
                    if (result.method === 'GET') result.method = 'POST';
                }
            }
            return result;
        };
        
        const populateFromCurl = (parsed) => {
            urlInput.value = parsed.url;
            requestTypeSelect.value = parsed.method;
            try { bodyInput.value = parsed.body ? JSON.stringify(JSON.parse(parsed.body), null, 2) : ''; } 
            catch { bodyInput.value = parsed.body; }
            headersList.innerHTML = '';
            parsed.headers.forEach(h => createHeaderInput(h.key, h.value));
            if (parsed.body) {
                document.querySelector('[data-tab-target="#body-content"]').click();
            }
        };

        const sendRequest = async (isAutomatedCall = false) => {
            const url = urlInput.value; if (!url) { alert('Please enter a URL.'); return; }
            const startTime = performance.now();
            if (!webhookIntervalId) {
                sendButton.disabled = true;
                sendButton.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Sending...`;
            }
            
            const headers = new Headers();
            const headerArrayForHistory = [];
            document.querySelectorAll('.header-item').forEach(item => {
                const key = item.querySelector('.header-key').value;
                const value = item.querySelector('.header-value').value;
                if (key) {
                    headers.append(key, value);
                    headerArrayForHistory.push({ key, value });
                }
            });

            const currentRequest = {
                id: currentRequestId,
                method: requestTypeSelect.value,
                url: url,
                headers: headerArrayForHistory,
                body: bodyInput.value
            };
            
            if (!isAutomatedCall) {
                const savedId = addOrUpdateHistory(currentRequest);
                loadRequestFromHistory(savedId);
            }

            if (['POST', 'PUT', 'PATCH'].includes(requestTypeSelect.value) && !headers.has('Content-Type')) { headers.append('Content-Type', 'application/json'); }
            
            let finalResponse;
            try {
                const response = await fetch(url, { method: requestTypeSelect.value, headers, body: ['POST', 'PUT', 'PATCH'].includes(requestTypeSelect.value) && bodyInput.value ? bodyInput.value : undefined });
                finalResponse = response;
                const responseText = await response.text();
                const endTime = performance.now();
                
                const duration = Math.round(endTime - startTime);
                
                const data = responseText ? JSON.parse(responseText) : { message: "OK: Empty response body from server." };
                displayStatus(response.status, response.ok);
                responseData = data;
                renderMetrics(response, responseData, duration);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
            } catch (error) {
                displayStatus(error.message || 'Request Failed', false);
                responseData = { error: true, message: error.message };
                if (finalResponse) {
                    const endTime = performance.now();
                    const duration = Math.round(endTime - startTime);
                    renderMetrics(finalResponse, responseData, duration);
                }
            } finally {
                const currentViewEl = document.querySelector('.response-view-btn.active');
                const currentView = currentViewEl ? currentViewEl.id.replace('view-', '').replace('-btn', '') : 'json';
                switchView(currentView);
                jsonResponseView.textContent = JSON.stringify(responseData, null, 2);
                if (!webhookIntervalId) {
                    sendButton.disabled = false;
                    sendButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5" /></svg> Send`;
                }
            }
        };
        
        const resetCurrentRequest = () => {
            currentRequestId = null;
            document.querySelectorAll('.history-item').forEach(item => item.classList.remove('bg-primary-50', 'dark:bg-primary-900/30'));
        };

        const handleSendClick = () => {
            if (isWebhookEnabled) {
                startWebhook();
            } else {
                sendRequest();
            }
        };

        // --- Event Listeners (Functionality preserved) ---
        sendButton.addEventListener('click', handleSendClick);
        addHeaderButton.addEventListener('click', () => createHeaderInput());
        modalImportBtn.addEventListener('click', () => {
            resetCurrentRequest();
            populateFromCurl(curlInput.value);
        });
        document.querySelectorAll('.response-view-btn').forEach(btn => {
            btn.addEventListener('click', () => switchView(btn.id.replace('view-', '').replace('-btn', '')));
        });
        clearHistoryBtn.addEventListener('click', clearHistory);
        stopWebhookBtn.addEventListener('click', stopWebhook);
        
        enableWebhookSwitch.addEventListener('change', (e) => {
            isWebhookEnabled = e.target.checked;
        });
        
        newRequestBtn.addEventListener('click', () => {
            resetCurrentRequest();
            urlInput.value = '';
            requestTypeSelect.value = 'GET';
            headersList.innerHTML = '';
            createHeaderInput();
            bodyInput.value = '';
            jsonResponseView.textContent = 'Your API response will appear here...';
            statusContainer.innerHTML = '';
            metricsContainer.innerHTML = '';
        });
        
        [urlInput, requestTypeSelect, bodyInput].forEach(el => el.addEventListener('input', resetCurrentRequest));
        headersList.addEventListener('input', resetCurrentRequest);

        // --- Initial Load ---
        if (headersList.childElementCount === 0) createHeaderInput();
        renderHistory();
    });
    </script>
</body>
</html>
