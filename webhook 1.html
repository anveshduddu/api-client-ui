<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Client ðŸš€</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- GSAP for Animations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    
    <!-- Highlight.js for Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">


    <!-- Custom Styles & Tailwind Config -->
    <style>
        /* Basic Style Resets & Font Family */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568; /* gray-600 */
            border-radius: 4px;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #718096; /* gray-500 */
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #2d3748; /* gray-800 */
        }

        /* Styles for Monaco Editor (if you were to add it) or CodeMirror-like textareas */
        .code-font {
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
        }
        
        /* Animation for spinning icon */
        .spinning {
            animation: spin 1.5s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Breathing animation for the webhook pill */
        .breathing {
            animation: breathe 2.5s ease-in-out infinite;
        }
        @keyframes breathe {
          0%, 100% { box-shadow: 0 0 2px 0px rgba(59, 130, 246, 0.4); }
          50% { box-shadow: 0 0 10px 3px rgba(59, 130, 246, 0.7); }
        }
        
        /* Syntax Highlighting Theme Adjustments */
        .hljs {
            background: #f1f5f9; /* slate-100 */
            color: #475569; /* slate-600 */
            border-radius: 0.5rem;
        }
        .dark .hljs {
            background: #1e293b; /* slate-800 */
            color: #abb2bf;
        }
        .dark .hljs-comment, .dark .hljs-quote { color: #5c6370; font-style: italic; }
        .dark .hljs-doctag, .dark .hljs-keyword, .dark .hljs-formula { color: #c678dd; }
        .dark .hljs-section, .dark .hljs-name, .dark .hljs-selector-tag, .dark .hljs-deletion, .dark .hljs-subst { color: #e06c75; }
        .dark .hljs-literal { color: #56b6c2; }
        .dark .hljs-string, .dark .hljs-regexp, .dark .hljs-addition, .dark .hljs-attribute, .dark .hljs-meta-string { color: #98c379; }
        .dark .hljs-built_in, .dark .hljs-class .hljs-title { color: #e6c07b; }
        .dark .hljs-attr, .dark .hljs-variable, .dark .hljs-template-variable, .dark .hljs-type, .dark .hljs-selector-class, .dark .hljs-selector-attr, .dark .hljs-selector-pseudo, .dark .hljs-number { color: #d19a66; }
        .dark .hljs-symbol, .dark .hljs-bullet, .dark .hljs-link, .dark .hljs-meta, .dark .hljs-selector-id, .dark .hljs-title { color: #61afef; }
        .dark .hljs-emphasis { font-style: italic; }
        .dark .hljs-strong { font-weight: bold; }
        
        /* Light theme overrides */
        html:not(.dark) .hljs-comment, html:not(.dark) .hljs-quote { color: #a0aec0; }
        html:not(.dark) .hljs-keyword, html:not(.dark) .hljs-selector-tag, html:not(.dark) .hljs-subst { color: #b545b5; }
        html:not(.dark) .hljs-number, html:not(.dark) .hljs-literal, html:not(.dark) .hljs-variable, html:not(.dark) .hljs-template-variable, html:not(.dark) .hljs-tag .hljs-attr { color: #b545b5; }
        html:not(.dark) .hljs-string, html:not(.dark) .hljs-doctag { color: #38a169; }
        html:not(.dark) .hljs-title, html:not(.dark) .hljs-section, html:not(.dark) .hljs-selector-id { color: #2b6cb0; }
        html:not(.dark) .hljs-class .hljs-title, html:not(.dark) .hljs-type { color: #d69d2e; }
        html:not(.dark) .hljs-attribute { color: #dd6b20; }
        html:not(.dark) .hljs-name { color: #c53030; }
        html:not(.dark) .hljs-regexp, html:not(.dark) .hljs-link { color: #00b5d8; }

    </style>
    <script>
        // Custom Tailwind CSS Configuration
        tailwind.config = {
            darkMode: 'class', // Enable dark mode using a class
            theme: {
                extend: {
                    colors: {
                        // Light Mode Palette
                        'primary': {
                            '50': '#eff6ff', '100': '#dbeafe', '200': '#bfdbfe', '300': '#93c5fd',
                            '400': '#60a5fa', '500': '#3b82f6', '600': '#2563eb', '700': '#1d4ed8',
                            '800': '#1e40af', '900': '#1e3a8a', '950': '#172554'
                        },
                        'light-bg': '#f8fafc', // slate-50
                        'light-surface': '#ffffff',
                        'light-muted': '#64748b', // slate-500
                        'light-border': '#e2e8f0', // slate-200
                        // Dark Mode Palette
                        'dark-bg': '#0f172a', // slate-900
                        'dark-surface': '#1e293b', // slate-800
                        'dark-muted': '#94a3b8', // slate-400
                        'dark-border': '#334155', // slate-700
                    },
                    transitionProperty: {
                        'width': 'width',
                        'margin': 'margin-left, margin-right',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-light-bg dark:bg-dark-bg text-slate-800 dark:text-slate-200 antialiased">

    <!-- Main Application Wrapper -->
    <div id="app-wrapper" class="flex h-screen overflow-hidden">

        <!-- History Sidebar -->
        <aside id="history-sidebar-container" class="bg-light-surface dark:bg-dark-surface/80 backdrop-blur-sm border-r border-light-border dark:border-dark-border flex-shrink-0 flex flex-col transition-width duration-300 ease-in-out w-80">
            <div class="flex items-center justify-between p-4 border-b border-light-border dark:border-dark-border h-16 flex-shrink-0">
                <div class="flex items-center gap-3">
                    <i class="fa-solid fa-clock-rotate-left text-primary-500 text-xl"></i>
                    <h2 class="font-bold text-lg">History</h2>
                </div>
                <div>
                    <button id="new-request-btn" title="New Request" class="p-2 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                    <button id="clear-history-btn" title="Clear All History" class="p-2 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                </div>
            </div>
            <div id="history-sidebar" class="flex-grow overflow-y-auto p-2 space-y-1">
                <!-- History items will be injected here -->
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-grow flex flex-col min-w-0">
            <!-- Top Navbar -->
            <header class="flex items-center justify-between p-4 border-b bg-light-surface/80 dark:bg-dark-surface/80 backdrop-blur-sm border-light-border dark:border-dark-border h-16 flex-shrink-0">
                <div class="flex items-center gap-3">
                    <button id="sidebar-toggle-btn" title="Toggle Sidebar" class="p-2 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
                        <i class="fa-solid fa-bars text-xl"></i>
                    </button>
                    <h1 class="text-xl font-bold text-slate-900 dark:text-white">API Client</h1>
                </div>

                <div id="webhook-status-pill" class="hidden items-center gap-2 bg-primary-500 text-white text-sm font-semibold px-3 py-1.5 rounded-full">
                    <i class="fa-solid fa-arrows-rotate"></i>
                    <span id="webhook-timer"></span>
                    <button id="stop-webhook-btn" class="ml-1 opacity-70 hover:opacity-100">&times;</button>
                </div>

                <div class="flex items-center gap-2">
                    <button id="toggle-theme-btn" class="p-2 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors text-xl">
                        <i id="theme-icon-light" class="fa-solid fa-sun"></i>
                        <i id="theme-icon-dark" class="fa-solid fa-moon hidden"></i>
                    </button>
                    <button id="open-settings-btn" class="p-2 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors text-xl">
                        <i class="fa-solid fa-gear"></i>
                    </button>
                </div>
            </header>
            
            <!-- Main scrollable content area -->
            <main id="main-content" class="flex-grow min-h-0 overflow-y-auto p-4 lg:p-6 space-y-6">
                <!-- Request UI -->
                <div class="bg-light-surface dark:bg-dark-surface rounded-xl shadow-sm border border-light-border dark:border-dark-border p-5">
                    <div class="flex flex-col sm:flex-row gap-2">
                        <select id="request-type" class="code-font font-semibold bg-slate-100 dark:bg-slate-700 border-light-border dark:border-slate-600 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition sm:w-32">
                            <option>GET</option><option>POST</option><option>PUT</option><option>DELETE</option><option>PATCH</option>
                        </select>
                        <input type="text" id="url-input" class="flex-grow bg-slate-100 dark:bg-slate-700 border-light-border dark:border-slate-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition code-font" placeholder="Enter URL or Import cURL">
                        <button id="curl-modal-btn" class="px-4 py-2 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors flex items-center justify-center gap-2" title="Import from cURL">
                             <i class="fa-solid fa-upload"></i>
                        </button>
                        <button id="send-button" class="bg-primary-600 text-white font-semibold px-5 py-2 rounded-md hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 dark:focus:ring-offset-dark-bg transition-all duration-200 ease-in-out flex items-center justify-center gap-2 transform hover:scale-105">
                            <i class="fa-solid fa-paper-plane"></i>
                            Send
                        </button>
                    </div>
                    <div class="mt-4">
                        <!-- Request Tabs -->
                        <div class="border-b border-light-border dark:border-dark-border">
                            <nav id="request-tab" class="-mb-px flex space-x-4" aria-label="Tabs">
                                <button data-tab-target="#headers-content" class="tab-btn active text-primary-600 dark:text-primary-400 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-primary-500">Headers</button>
                                <button data-tab-target="#body-content" class="tab-btn text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-300 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent">Body</button>
                            </nav>
                        </div>
                        <div class="pt-4">
                            <div id="headers-content" class="tab-pane active space-y-2">
                                <div id="headers-list" class="space-y-2"></div>
                                <button id="add-header-button" class="text-sm font-semibold text-primary-600 hover:text-primary-700 dark:text-primary-400 dark:hover:text-primary-300 flex items-center gap-1">
                                    <i class="fa-solid fa-plus"></i>
                                    Add Header
                                </button>
                            </div>
                            <div id="body-content" class="tab-pane hidden">
                                <textarea id="body-input" class="w-full h-40 bg-slate-100 dark:bg-slate-900/50 border-light-border dark:border-dark-border rounded-md p-3 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition code-font whitespace-pre-wrap" placeholder="Request body (e.g., JSON)"></textarea>
                                <div class="mt-2">
                                    <label class="flex items-center text-sm text-slate-600 dark:text-slate-400">
                                        <input type="checkbox" id="body-wrap-toggle" class="h-4 w-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500" checked>
                                        <span class="ml-2">Word Wrap</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Response UI -->
                <div class="bg-light-surface dark:bg-dark-surface rounded-xl shadow-sm border border-light-border dark:border-dark-border flex flex-col min-h-0">
                    <div class="p-4 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 border-b border-light-border dark:border-dark-border flex-shrink-0">
                        <div class="flex items-center gap-4">
                            <h3 class="text-lg font-bold">Response</h3>
                            <div id="status-container"></div>
                        </div>
                        <div class="flex items-center gap-2">
                            <div id="response-view-switcher" class="flex items-center bg-slate-100 dark:bg-slate-700 p-1 rounded-lg text-sm">
                                <button id="view-json-btn" class="response-view-btn active px-3 py-1 font-semibold rounded-md">JSON</button>
                                <button id="view-cards-btn" class="response-view-btn px-3 py-1 font-semibold rounded-md">Cards</button>
                                <button id="view-table-btn" class="response-view-btn px-3 py-1 font-semibold rounded-md">Table</button>
                            </div>
                             <button id="extract-json-btn" class="p-2 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" title="Extract from JSON" disabled>
                                <i class="fa-solid fa-wand-magic-sparkles"></i>
                            </button>
                        </div>
                    </div>
                    <div class="flex-grow min-h-0">
                        <div class="border-b border-light-border dark:border-dark-border flex-shrink-0">
                            <nav id="response-details-tab" class="flex space-x-4 px-4" aria-label="Tabs">
                                <button data-tab-target="#response-body-content" class="tab-btn active text-primary-600 dark:text-primary-400 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-primary-500">Body</button>
                                <button data-tab-target="#response-metrics-content" class="tab-btn text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-300 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent">Metrics</button>
                            </nav>
                        </div>
                        <div class="p-4 overflow-y-auto">
                            <div id="response-body-content" class="tab-pane active">
                                <pre class="overflow-auto max-h-[40vh]"><code id="json-response" class="language-json p-4 rounded-lg text-sm">Your API response will appear here...</code></pre>
                                <div id="cards-response-container" class="hidden space-y-2 overflow-y-auto max-h-[40vh]"></div>
                                <div id="table-response-container" class="hidden overflow-auto max-h-[40vh]">
                                    <table class="w-full text-sm text-left" id="table-response"></table>
                                </div>
                            </div>
                            <div id="response-metrics-content" class="tab-pane hidden">
                                <div id="metrics-container" class="text-sm space-y-3 p-2"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Settings Offcanvas -->
    <div id="settings-offcanvas" class="fixed top-0 right-0 z-40 h-screen p-4 overflow-y-auto transition-transform translate-x-full bg-light-surface dark:bg-dark-surface w-80 shadow-xl" tabindex="-1">
        <div class="flex items-center justify-between">
            <h5 class="text-base font-semibold uppercase">Webhook Settings</h5>
            <button type="button" id="settings-close-btn" class="p-1.5 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
        <div class="py-4 space-y-4">
            <label for="enable-webhook-switch" class="flex items-center cursor-pointer">
                <div class="relative">
                    <input type="checkbox" id="enable-webhook-switch" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary-600"></div>
                </div>
                <span class="ml-3 text-sm font-medium">Enable Webhook on Send</span>
            </label>
            <div id="webhook-options" class="space-y-2">
                <label for="webhook-interval-input" class="text-sm font-medium">Interval (seconds)</label>
                <input type="number" id="webhook-interval-input" value="10" min="2" class="w-full bg-slate-100 dark:bg-slate-700 border-light-border dark:border-slate-600 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition">
                <p class="text-xs text-light-muted dark:text-dark-muted">The request will repeat at this interval for a maximum of 2 minutes.</p>
            </div>
        </div>
    </div>
    <div id="settings-offcanvas-backdrop" class="bg-gray-900/50 dark:bg-gray-900/80 fixed inset-0 z-30 hidden"></div>

    <!-- cURL Import Modal -->
    <div id="curl-modal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-full">
        <div class="relative p-4 w-full max-w-2xl h-full flex items-center">
            <div class="relative bg-light-surface dark:bg-dark-surface rounded-lg shadow-xl w-full">
                <div class="flex items-center justify-between p-4 border-b rounded-t dark:border-gray-600">
                    <h3 class="text-xl font-semibold">Import from cURL</h3>
                    <button type="button" id="curl-close-btn" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
                <div class="p-4 md:p-5 space-y-4">
                    <textarea id="curl-input" class="w-full h-48 bg-slate-100 dark:bg-slate-900/50 border-light-border dark:border-dark-border rounded-md p-3 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition code-font" placeholder="Paste your cURL command here..."></textarea>
                </div>
                <div class="flex items-center p-4 md:p-5 border-t border-gray-200 rounded-b dark:border-gray-600">
                    <button id="modal-import-btn" type="button" class="text-white bg-primary-600 hover:bg-primary-700 focus:ring-4 focus:outline-none focus:ring-primary-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-primary-600 dark:hover:bg-primary-700 dark:focus:ring-primary-800">Import</button>
                    <button id="curl-cancel-btn" type="button" class="ms-3 text-gray-500 bg-white hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-blue-300 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 focus:z-10 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-500 dark:hover:text-white dark:hover:bg-gray-600 dark:focus:ring-gray-600">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- JSON Extract Modal -->
    <div id="extract-modal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-full">
        <div class="relative p-4 w-full max-w-4xl h-full flex items-center">
            <div class="relative bg-light-surface dark:bg-dark-surface rounded-lg shadow-xl w-full flex flex-col max-h-[90vh]">
                <div class="flex items-center justify-between p-4 border-b rounded-t dark:border-gray-600">
                    <h3 class="text-xl font-semibold">Extract from JSON Response</h3>
                    <button type="button" id="extract-close-btn" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
                <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4 flex-grow min-h-0">
                    <div class="flex flex-col">
                        <label for="extract-paths-input" class="mb-2 font-semibold">Paths to Extract (one per line)</label>
                        <textarea id="extract-paths-input" class="w-full h-full bg-slate-100 dark:bg-slate-900/50 border-light-border dark:border-dark-border rounded-md p-3 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition code-font" placeholder="user.name&#10;data.testcases[*].id"></textarea>
                    </div>
                    <div class="flex flex-col min-h-0">
                        <label for="extract-results-output" class="mb-2 font-semibold">Results</label>
                        <pre class="w-full h-full flex-grow min-h-0"><code id="extract-results-output" class="language-json p-4 rounded-lg text-sm overflow-auto h-full"></code></pre>
                    </div>
                </div>
                 <div class="px-4 pb-4 border-t border-light-border dark:border-dark-border pt-4 flex flex-wrap items-center justify-between gap-4">
                     <div class="flex flex-wrap items-center gap-x-6 gap-y-2">
                        <label class="flex items-center text-sm text-slate-600 dark:text-slate-400">
                            <input type="checkbox" id="extract-search-all-toggle" class="h-4 w-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500 disabled:opacity-50" disabled>
                            <span class="ml-2">Search all objects in root array</span>
                        </label>
                         <div>
                            <span class="text-sm mr-2">Format:</span>
                            <input type="radio" id="format-json" name="extract-format" value="json" class="mr-1" checked><label for="format-json" class="mr-3 text-sm">JSON</label>
                            <input type="radio" id="format-list" name="extract-format" value="list" class="mr-1"><label for="format-list" class="text-sm">List</label>
                         </div>
                     </div>
                     <div class="flex items-center gap-2">
                        <button id="copy-extract-results-btn" class="px-3 py-1.5 text-sm rounded-md bg-slate-200 hover:bg-slate-300 dark:bg-slate-600 dark:hover:bg-slate-500 transition-colors flex items-center gap-2">
                            <i class="fa-solid fa-copy"></i> Copy
                        </button>
                        <button id="clear-extract-paths-btn" class="px-3 py-1.5 text-sm rounded-md bg-slate-200 hover:bg-slate-300 dark:bg-slate-600 dark:hover:bg-slate-500 transition-colors flex items-center gap-2">
                            <i class="fa-solid fa-eraser"></i> Clear
                        </button>
                     </div>
                </div>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Element References (New Structure) ---
        const urlInput = document.getElementById('url-input');
        const requestTypeSelect = document.getElementById('request-type');
        const sendButton = document.getElementById('send-button');
        const headersList = document.getElementById('headers-list');
        const addHeaderButton = document.getElementById('add-header-button');
        const bodyInput = document.getElementById('body-input');
        const bodyWrapToggle = document.getElementById('body-wrap-toggle');
        const jsonResponseView = document.getElementById('json-response');
        const cardsResponseContainer = document.getElementById('cards-response-container');
        const tableResponseContainer = document.getElementById('table-response-container');
        const statusContainer = document.getElementById('status-container');
        const viewJsonBtn = document.getElementById('view-json-btn');
        const viewCardsBtn = document.getElementById('view-cards-btn');
        const viewTableBtn = document.getElementById('view-table-btn');
        const curlInput = document.getElementById('curl-input');
        const modalImportBtn = document.getElementById('modal-import-btn');
        const historySidebar = document.getElementById('history-sidebar');
        const sidebarContainer = document.getElementById('history-sidebar-container');
        const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
        const clearHistoryBtn = document.getElementById('clear-history-btn');
        const newRequestBtn = document.getElementById('new-request-btn');
        const metricsContainer = document.getElementById('metrics-container');
        const webhookStatusPill = document.getElementById('webhook-status-pill');
        const stopWebhookBtn = document.getElementById('stop-webhook-btn');
        const webhookTimer = document.getElementById('webhook-timer');
        const enableWebhookSwitch = document.getElementById('enable-webhook-switch');
        const webhookIntervalInput = document.getElementById('webhook-interval-input');
        const toggleThemeBtn = document.getElementById('toggle-theme-btn');
        const openSettingsBtn = document.getElementById('open-settings-btn');
        const extractJsonBtn = document.getElementById('extract-json-btn');
        const extractPathsInput = document.getElementById('extract-paths-input');
        const extractResultsOutput = document.getElementById('extract-results-output');
        const extractSearchAllToggle = document.getElementById('extract-search-all-toggle');
        const copyExtractResultsBtn = document.getElementById('copy-extract-results-btn');
        const clearExtractPathsBtn = document.getElementById('clear-extract-paths-btn');
        
        // Modal & Drawer Elements
        const curlModalBtn = document.getElementById('curl-modal-btn');
        const curlModal = document.getElementById('curl-modal');
        const curlCloseBtn = document.getElementById('curl-close-btn');
        const curlCancelBtn = document.getElementById('curl-cancel-btn');
        
        const extractModal = document.getElementById('extract-modal');
        const extractCloseBtn = document.getElementById('extract-close-btn');

        const settingsOffcanvas = document.getElementById('settings-offcanvas');
        const settingsOffcanvasBackdrop = document.getElementById('settings-offcanvas-backdrop');
        const settingsCloseBtn = document.getElementById('settings-close-btn');

        let responseData = null;
        let currentRequestId = null;
        let webhookIntervalId = null;
        let webhookTimeoutId = null;
        let webhookCountdownId = null;
        let isWebhookEnabled = false;

        // --- GSAP Animations ---
        gsap.from("#main-content > div", {
            duration: 0.5,
            y: 20,
            opacity: 0,
            stagger: 0.1,
            ease: "power2.out",
            delay: 0.2
        });

        // --- Theme Toggle ---
        const themeIconLight = document.getElementById('theme-icon-light');
        const themeIconDark = document.getElementById('theme-icon-dark');
        const setTheme = (theme) => {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                themeIconLight.classList.add('hidden');
                themeIconDark.classList.remove('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                themeIconLight.classList.remove('hidden');
                themeIconDark.classList.add('hidden');
            }
            localStorage.setItem('apiClientTheme', theme);
        };
        toggleThemeBtn.addEventListener('click', () => {
            const currentTheme = localStorage.getItem('apiClientTheme');
            setTheme(currentTheme === 'dark' ? 'light' : 'dark');
        });
        const savedTheme = localStorage.getItem('apiClientTheme');
        if (savedTheme) {
            setTheme(savedTheme);
        } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
            setTheme('dark');
        }

        // --- UI & Visualization Functions ---
        const createHeaderInput = (key = '', value = '') => {
            const row = document.createElement('div');
            row.className = 'flex items-center gap-2 header-item';
            row.innerHTML = `
                <input type="text" class="header-key flex-grow bg-slate-100 dark:bg-slate-700 border-light-border dark:border-slate-600 rounded-md px-3 py-1.5 text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition" placeholder="Key" value="${key}">
                <input type="text" class="header-value flex-grow bg-slate-100 dark:bg-slate-700 border-light-border dark:border-slate-600 rounded-md px-3 py-1.5 text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition" placeholder="Value" value="${value}">
                <button class="remove-header-btn p-2 rounded-md text-slate-400 hover:bg-red-100 hover:text-red-600 dark:hover:bg-red-900/50 dark:hover:text-red-400 transition-colors" type="button">
                    <i class="fa-solid fa-xmark"></i>
                </button>`;
            headersList.appendChild(row);
            gsap.from(row, { duration: 0.3, opacity: 0, y: -10, ease: "power2.out" });
            row.querySelector('.remove-header-btn').addEventListener('click', () => {
                gsap.to(row, { duration: 0.3, opacity: 0, x: 20, ease: "power2.in", onComplete: () => row.remove() });
            });
        };

        const displayStatus = (status, ok) => {
            const statusClass = ok ? 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300' : 'bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300';
            statusContainer.innerHTML = `<span class="px-2.5 py-1 text-sm font-semibold rounded-full ${statusClass}">Status: ${status}</span>`;
        };

        const switchView = (view) => {
            [jsonResponseView.parentElement, cardsResponseContainer, tableResponseContainer].forEach(v => v.classList.add('hidden'));
            document.querySelectorAll('.response-view-btn').forEach(b => b.classList.remove('active', 'bg-white', 'dark:bg-slate-800', 'text-slate-900', 'dark:text-white'));
            
            const btn = document.getElementById(`view-${view}-btn`);
            btn.classList.add('active', 'bg-white', 'dark:bg-slate-800', 'text-slate-900', 'dark:text-white');

            if (view === 'json') { jsonResponseView.parentElement.classList.remove('hidden'); } 
            else if (view === 'cards') { cardsResponseContainer.classList.remove('hidden'); if (responseData) renderCards(responseData); }
            else if (view === 'table') { tableResponseContainer.classList.remove('hidden'); if (responseData) renderTable(responseData); }
        };

        const renderTable = (data) => {
            const tableEl = document.getElementById('table-response');
            tableEl.innerHTML = '';
            if (!Array.isArray(data) || data.length === 0) {
                tableEl.innerHTML = '<thead class="text-xs text-slate-700 uppercase bg-slate-50 dark:bg-slate-700 dark:text-slate-400"><tr><th class="px-6 py-3">Info</th></tr></thead><tbody><tr class="bg-white border-b dark:bg-slate-800 dark:border-slate-700"><td class="px-6 py-4">Data is not an array or is empty.</td></tr></tbody>';
                return;
            }
            const headers = Object.keys(data[0]);
            const thead = document.createElement('thead');
            thead.className = "text-xs text-slate-700 uppercase bg-slate-50 dark:bg-slate-700 dark:text-slate-400 sticky top-0";
            thead.innerHTML = `<tr>${headers.map(h => `<th scope="col" class="px-6 py-3">${h}</th>`).join('')}</tr>`;
            const tbody = document.createElement('tbody');
            tbody.innerHTML = data.map(obj => `<tr class="bg-white border-b dark:bg-slate-800 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-600">${headers.map(h => `<td class="px-6 py-4">${typeof obj[h] === 'object' ? JSON.stringify(obj[h]) : obj[h]}</td>`).join('')}</tr>`).join('');
            tableEl.append(thead, tbody);
        };
        
        const renderCards = (data) => {
            cardsResponseContainer.innerHTML = '';
            const dataArray = Array.isArray(data) ? data : [data];
            if (dataArray.length === 0 || (dataArray[0] && Object.keys(dataArray[0]).length === 0)) {
                cardsResponseContainer.innerHTML = '<p class="text-light-muted dark:text-dark-muted">No data to display in card view.</p>';
                return;
            }
            dataArray.forEach((item, index) => {
                const itemId = `card-item-${index}`;
                const title = item.name || item.title || item.id || `Item ${index + 1}`;
                const card = document.createElement('div');
                card.className = "bg-slate-100 dark:bg-slate-900/50 rounded-lg";
                card.innerHTML = `
                    <h2>
                        <button type="button" class="flex items-center justify-between w-full p-4 font-medium text-left" data-accordion-target="#${itemId}">
                            <span>${title}</span>
                            <i class="fa-solid fa-chevron-down shrink-0 transition-transform"></i>
                        </button>
                    </h2>
                    <div id="${itemId}" class="hidden p-4 border-t border-light-border dark:border-dark-border">
                        <pre class="code-font text-sm"><code>${JSON.stringify(item, null, 2)}</code></pre>
                    </div>`;
                cardsResponseContainer.appendChild(card);
                const button = card.querySelector('button');
                const content = card.querySelector(`#${itemId}`);
                const icon = card.querySelector('i');
                button.addEventListener('click', () => {
                    content.classList.toggle('hidden');
                    icon.classList.toggle('rotate-180');
                });
            });
        };

        const renderMetrics = (response, responseBody, duration) => {
            metricsContainer.innerHTML = '';
            const headers = response.headers;

            const createMetricRow = (label, value) => {
                if (value === null || value === undefined || value === '') return '';
                return `
                    <div class="grid grid-cols-3 gap-4">
                        <dt class="font-medium text-light-muted dark:text-dark-muted">${label}</dt>
                        <dd class="col-span-2 font-mono text-slate-700 dark:text-slate-300 break-all">${value}</dd>
                    </div>`;
            };
            
            let metricsHTML = '<dl class="space-y-3">';
            metricsHTML += createMetricRow('Status Code', response.status);
            metricsHTML += createMetricRow('Response Time', `${duration} ms`);
            metricsHTML += createMetricRow('Content-Type', headers.get('content-type'));
            metricsHTML += createMetricRow('Content-Length', headers.get('content-length') ? `${headers.get('content-length')} bytes` : null);
            metricsHTML += createMetricRow('Cache-Control', headers.get('cache-control'));
            metricsHTML += createMetricRow('ETag', headers.get('etag'));
            metricsHTML += createMetricRow('Last-Modified', headers.get('last-modified'));
            metricsHTML += createMetricRow('Server', headers.get('server'));
            metricsHTML += createMetricRow('X-Powered-By', headers.get('x-powered-by'));
            metricsHTML += createMetricRow('X-Request-ID', headers.get('x-request-id') || headers.get('x-correlation-id'));
            metricsHTML += createMetricRow('X-API-Version', headers.get('x-api-version'));
            metricsHTML += createMetricRow('Deprecation', headers.get('deprecation'));
            
            // Rate Limiting
            const rateLimit = headers.get('x-ratelimit-limit');
            if (rateLimit) {
                metricsHTML += createMetricRow('Rate Limit', `${headers.get('x-ratelimit-remaining')} / ${rateLimit}`);
                const resetTime = headers.get('x-ratelimit-reset');
                if(resetTime) {
                    const resetDate = new Date(resetTime * 1000);
                    metricsHTML += createMetricRow('Rate Limit Reset', resetDate.toLocaleTimeString());
                }
            }

            metricsHTML += createMetricRow('Retry-After', headers.get('retry-after'));

            // Authorization & Errors from body
            if (response.status === 401 || response.status === 403) {
                 metricsHTML += createMetricRow('Authorization', 'Failed (401/403)');
            }
            if (responseBody && responseBody.error) {
                metricsHTML += createMetricRow('Error Message', responseBody.error.message || JSON.stringify(responseBody.error));
            } else if (responseBody && responseBody.message && !response.ok) {
                metricsHTML += createMetricRow('Error Message', responseBody.message);
            }
            
            if (responseBody && responseBody.token_expires_in) {
                 metricsHTML += createMetricRow('Token Expires In', `${responseBody.token_expires_in} seconds`);
            }

            metricsHTML += '</dl>';
            metricsContainer.innerHTML = metricsHTML;
        };
        
        // --- Tab Switching Logic ---
        document.querySelectorAll('[data-tab-target]').forEach(button => {
            button.addEventListener('click', () => {
                const nav = button.closest('nav');
                const targetSelector = button.dataset.tabTarget;
                const targetPane = document.querySelector(targetSelector);

                // Update button states
                nav.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active', 'text-primary-600', 'dark:text-primary-400', 'border-primary-500');
                    btn.classList.add('text-slate-500', 'dark:text-slate-400', 'border-transparent');
                });
                button.classList.add('active', 'text-primary-600', 'dark:text-primary-400', 'border-primary-500');
                button.classList.remove('text-slate-500', 'dark:text-slate-400', 'border-transparent');

                // Update pane visibility
                targetPane.parentElement.querySelectorAll('.tab-pane').forEach(pane => {
                    pane.classList.remove('active');
                    pane.classList.add('hidden');
                });
                targetPane.classList.add('active');
                targetPane.classList.remove('hidden');
            });
        });

        // --- Modal & Drawer Toggling ---
        const toggleModal = (modalEl, show) => {
            if (!modalEl) return;
            if (show) {
                modalEl.classList.remove('hidden');
                modalEl.classList.add('flex');
            } else {
                modalEl.classList.add('hidden');
                modalEl.classList.remove('flex');
            }
        };

        curlModalBtn.addEventListener('click', () => toggleModal(curlModal, true));
        curlCloseBtn.addEventListener('click', () => toggleModal(curlModal, false));
        curlCancelBtn.addEventListener('click', () => toggleModal(curlModal, false));
        
        extractJsonBtn.addEventListener('click', () => toggleModal(extractModal, true));
        extractCloseBtn.addEventListener('click', () => toggleModal(extractModal, false));

        const toggleDrawer = (show) => {
            if(show) {
                settingsOffcanvas.classList.remove('translate-x-full');
                settingsOffcanvasBackdrop.classList.remove('hidden');
            } else {
                settingsOffcanvas.classList.add('translate-x-full');
                settingsOffcanvasBackdrop.classList.add('hidden');
            }
        };
        openSettingsBtn.addEventListener('click', (e) => {
            e.preventDefault();
            toggleDrawer(true);
        });
        settingsCloseBtn.addEventListener('click', () => toggleDrawer(false));
        settingsOffcanvasBackdrop.addEventListener('click', () => toggleDrawer(false));


        // --- Webhook Logic (Functionality preserved) ---
        const startWebhook = () => {
            const intervalSeconds = parseInt(webhookIntervalInput.value, 10);
            if (!intervalSeconds || intervalSeconds < 2) {
                alert('Interval must be at least 2 seconds.');
                return;
            }
            
            stopWebhook(); 
            sendButton.disabled = true;
            webhookStatusPill.classList.remove('hidden');
            webhookStatusPill.classList.add('flex', 'breathing');
            webhookStatusPill.querySelector('i').classList.add('spinning');
            
            const durationMs = 120 * 1000;
            let remainingMs = durationMs;

            const updateTimer = () => {
                webhookTimer.textContent = `Stopping in ${Math.ceil(remainingMs / 1000)}s`;
                remainingMs -= 1000;
            };

            sendRequest(true); 
            webhookIntervalId = setInterval(() => sendRequest(true), intervalSeconds * 1000);
            
            updateTimer();
            webhookCountdownId = setInterval(updateTimer, 1000);

            webhookTimeoutId = setTimeout(stopWebhook, durationMs);
        };

        const stopWebhook = () => {
            clearInterval(webhookIntervalId);
            clearTimeout(webhookTimeoutId);
            clearInterval(webhookCountdownId);
            webhookIntervalId = null;
            webhookTimeoutId = null;
            webhookCountdownId = null;
            webhookStatusPill.classList.add('hidden');
            webhookStatusPill.classList.remove('flex', 'breathing');
            const icon = webhookStatusPill.querySelector('i');
            if(icon) icon.classList.remove('spinning');

            sendButton.disabled = false;
            sendButton.innerHTML = `<i class="fa-solid fa-paper-plane"></i> Send`;
        };

        // --- Sidebar & History Logic (Functionality preserved) ---
        sidebarToggleBtn.addEventListener('click', () => {
             sidebarContainer.classList.toggle('w-80');
             sidebarContainer.classList.toggle('w-0');
             sidebarContainer.classList.toggle('p-0');
        });
        
        const getHistory = () => JSON.parse(localStorage.getItem('apiClientHistory') || '[]');
        const saveHistory = (history) => localStorage.setItem('apiClientHistory', JSON.stringify(history));

        const clearHistory = () => {
            if (confirm('Are you sure you want to clear all request history?')) {
                localStorage.removeItem('apiClientHistory');
                renderHistory();
            }
        };

        const addOrUpdateHistory = (request) => {
            let history = getHistory();
            if (request.id && history.some(h => h.id === request.id)) {
                history = history.map(h => h.id === request.id ? request : h);
            } else {
                request.id = crypto.randomUUID();
                history.unshift(request);
            }
            saveHistory(history);
            renderHistory();
            return request.id;
        };

        const deleteRequestFromHistory = (requestId) => {
            let history = getHistory();
            history = history.filter(req => req.id !== requestId);
            saveHistory(history);
            renderHistory();
        };

        const renderHistory = () => {
            const history = getHistory();
            historySidebar.innerHTML = '';
            if (history.length === 0) {
                historySidebar.innerHTML = '<div class="p-4 text-center text-sm text-light-muted dark:text-dark-muted">No history yet.</div>';
                return;
            }
            history.forEach(req => {
                const methodColors = {
                    'GET': 'text-green-500', 'POST': 'text-yellow-500', 'PUT': 'text-blue-500',
                    'PATCH': 'text-purple-500', 'DELETE': 'text-red-500'
                };
                const item = document.createElement('div');
                item.className = 'history-item flex items-center gap-2 p-2 rounded-md cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-700/50 transition-colors';
                item.dataset.requestId = req.id;
                item.innerHTML = `
                    <span class="font-bold text-xs w-14 text-center ${methodColors[req.method] || 'text-slate-500'}">${req.method}</span>
                    <span class="url text-sm flex-grow truncate">${req.url}</span>
                    <button class="delete-history-btn p-1 rounded-md text-slate-400 hover:text-red-500 hover:bg-red-100 dark:hover:bg-red-900/50 flex-shrink-0">
                         <i class="fa-solid fa-xmark"></i>
                    </button>
                `;
                item.addEventListener('click', (e) => {
                    if (e.target.closest('.delete-history-btn')) return;
                    loadRequestFromHistory(req.id);
                });
                item.querySelector('.delete-history-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteRequestFromHistory(req.id);
                });
                historySidebar.appendChild(item);
            });
        };

        const loadRequestFromHistory = (requestId) => {
            const history = getHistory();
            const request = history.find(req => req.id === requestId);
            if (!request) return;

            currentRequestId = request.id;
            urlInput.value = request.url;
            requestTypeSelect.value = request.method;
            bodyInput.value = request.body;
            headersList.innerHTML = '';
            (request.headers || []).forEach(h => createHeaderInput(h.key, h.value));
            
            document.querySelectorAll('.history-item').forEach(item => item.classList.remove('bg-primary-50', 'dark:bg-primary-900/30'));
            const activeItem = document.querySelector(`.history-item[data-request-id="${requestId}"]`);
            if (activeItem) activeItem.classList.add('bg-primary-50', 'dark:bg-primary-900/30');
        };
        
        const parseCurlCommand = (curlString) => {
            const result = { url: '', method: 'GET', headers: [], body: '' };
            const cleanCurl = curlString.replace(/\\\n/g, ' ').replace(/\n/g, ' ').trim();
            const args = [];
            let currentArg = '', inQuote = null;
            for (let i = 0; i < cleanCurl.length; i++) {
                const char = cleanCurl[i];
                if (inQuote) {
                    if (char === inQuote && cleanCurl[i - 1] !== '\\') inQuote = null;
                    else currentArg += char;
                } else {
                    if (char === "'" || char === '"') inQuote = char;
                    else if (char === ' ') { if (currentArg) { args.push(currentArg); currentArg = ''; } } 
                    else currentArg += char;
                }
            }
            if (currentArg) args.push(currentArg);
            for (let i = 0; i < args.length; i++) {
                const arg = args[i];
                if (arg.startsWith('http')) { if (!result.url) result.url = arg; } 
                else if (arg === '-X' || arg === '--request') { result.method = args[++i].toUpperCase(); } 
                else if (arg === '-H' || arg === '--header') {
                    const header = args[++i];
                    const [key, ...valueParts] = header.split(/:(.*)/s);
                    if (key && valueParts.length > 0) result.headers.push({ key: key.trim(), value: valueParts[0].trim() });
                } else if (arg === '-d' || arg === '--data' || arg === '--data-raw') {
                    result.body = args[++i];
                    if (result.method === 'GET') result.method = 'POST';
                }
            }
            return result;
        };
        
        const populateFromCurl = (parsed) => {
            urlInput.value = parsed.url;
            requestTypeSelect.value = parsed.method;
            try { bodyInput.value = parsed.body ? JSON.stringify(JSON.parse(parsed.body), null, 2) : ''; } 
            catch { bodyInput.value = parsed.body; }
            headersList.innerHTML = '';
            parsed.headers.forEach(h => createHeaderInput(h.key, h.value));
            if (parsed.body) {
                document.querySelector('[data-tab-target="#body-content"]').click();
            }
        };

        const sendRequest = async (isAutomatedCall = false) => {
            const url = urlInput.value; if (!url) { alert('Please enter a URL.'); return; }
            const startTime = performance.now();
            if (!webhookIntervalId) {
                sendButton.disabled = true;
                sendButton.innerHTML = `<i class="fa-solid fa-spinner animate-spin -ml-1 mr-3"></i> Sending...`;
            }
            
            const headers = new Headers();
            const headerArrayForHistory = [];
            document.querySelectorAll('.header-item').forEach(item => {
                const key = item.querySelector('.header-key').value;
                const value = item.querySelector('.header-value').value;
                if (key) {
                    headers.append(key, value);
                    headerArrayForHistory.push({ key, value });
                }
            });

            const currentRequest = {
                id: currentRequestId,
                method: requestTypeSelect.value,
                url: url,
                headers: headerArrayForHistory,
                body: bodyInput.value
            };
            
            if (!isAutomatedCall) {
                const savedId = addOrUpdateHistory(currentRequest);
                loadRequestFromHistory(savedId);
            }

            if (['POST', 'PUT', 'PATCH'].includes(requestTypeSelect.value) && !headers.has('Content-Type')) { headers.append('Content-Type', 'application/json'); }
            
            let finalResponse;
            try {
                const response = await fetch(url, { method: requestTypeSelect.value, headers, body: ['POST', 'PUT', 'PATCH'].includes(requestTypeSelect.value) && bodyInput.value ? bodyInput.value : undefined });
                finalResponse = response;
                const responseText = await response.text();
                const endTime = performance.now();
                
                const duration = Math.round(endTime - startTime);
                
                const data = responseText ? JSON.parse(responseText) : { message: "OK: Empty response body from server." };
                displayStatus(response.status, response.ok);
                responseData = data;
                renderMetrics(response, responseData, duration);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
            } catch (error) {
                displayStatus(error.message || 'Request Failed', false);
                responseData = { error: true, message: error.message };
                if (finalResponse) {
                    const endTime = performance.now();
                    const duration = Math.round(endTime - startTime);
                    renderMetrics(finalResponse, responseData, duration);
                }
            } finally {
                const currentViewEl = document.querySelector('.response-view-btn.active');
                const currentView = currentViewEl ? currentViewEl.id.replace('view-', '').replace('-btn', '') : 'json';
                
                jsonResponseView.textContent = JSON.stringify(responseData, null, 2);
                delete jsonResponseView.dataset.highlighted;
                jsonResponseView.className = 'language-json p-4 rounded-lg text-sm';
                hljs.highlightElement(jsonResponseView);
                
                // Enable or disable extract button and search-all toggle
                const isObject = typeof responseData === 'object' && responseData !== null;
                const isArray = Array.isArray(responseData);
                extractJsonBtn.disabled = !isObject;
                extractSearchAllToggle.disabled = !isArray;
                if (!isArray) extractSearchAllToggle.checked = false;


                switchView(currentView);

                if (!webhookIntervalId) {
                    sendButton.disabled = false;
                    sendButton.innerHTML = `<i class="fa-solid fa-paper-plane"></i> Send`;
                }
            }
        };
        
        const resetCurrentRequest = () => {
            currentRequestId = null;
            document.querySelectorAll('.history-item').forEach(item => item.classList.remove('bg-primary-50', 'dark:bg-primary-900/30'));
        };

        const handleSendClick = () => {
            if (isWebhookEnabled) {
                startWebhook();
            } else {
                sendRequest();
            }
        };
        
        // --- JSON Extraction Logic ---
        const findValuesByPath = (obj, path) => {
            const keys = path.replace(/\[(\d+)\]/g, '.$1').replace(/\[\*\]/g, '.*').split('.');
            let results = [];

            function search(current, remainingKeys) {
                if (current === null || current === undefined) return;

                if (!remainingKeys.length) {
                    results.push(current);
                    return;
                }

                const key = remainingKeys[0];
                const nextKeys = remainingKeys.slice(1);

                if (key === '*') {
                    if (Array.isArray(current)) {
                        current.forEach(item => search(item, nextKeys));
                    }
                } else if (typeof current === 'object' && key in current) {
                    search(current[key], nextKeys);
                }
            }

            search(obj, keys);
            return results;
        };
        
        const updateExtractionResults = () => {
            if (!responseData) return;
            
            const paths = extractPathsInput.value.split('\n').filter(p => p.trim() !== '');
            const searchAll = extractSearchAllToggle.checked;
            const outputFormat = document.querySelector('input[name="extract-format"]:checked').value;
            let results = {};
            
            if (outputFormat === 'list') {
                let listResults = [];
                paths.forEach(path => {
                    const trimmedPath = path.trim();
                    if (searchAll && Array.isArray(responseData)) {
                        responseData.forEach(item => {
                            listResults.push(...findValuesByPath(item, trimmedPath));
                        });
                    } else {
                        listResults.push(...findValuesByPath(responseData, trimmedPath));
                    }
                });
                extractResultsOutput.textContent = JSON.stringify(listResults, null, 2);
            } else {
                paths.forEach(path => {
                    const trimmedPath = path.trim();
                    if (searchAll && Array.isArray(responseData)) {
                        results[trimmedPath] = responseData.map(item => findValuesByPath(item, trimmedPath)).flat();
                    } else {
                        results[trimmedPath] = findValuesByPath(responseData, trimmedPath);
                    }
                });
                extractResultsOutput.textContent = JSON.stringify(results, null, 2);
            }
            
            delete extractResultsOutput.dataset.highlighted;
            extractResultsOutput.className = 'language-json p-4 rounded-lg text-sm overflow-auto h-full';
            hljs.highlightElement(extractResultsOutput);
        };


        // --- Event Listeners ---
        sendButton.addEventListener('click', handleSendClick);
        addHeaderButton.addEventListener('click', () => createHeaderInput());
        modalImportBtn.addEventListener('click', () => {
            resetCurrentRequest();
            populateFromCurl(curlInput.value);
            toggleModal(curlModal, false);
        });
        document.querySelectorAll('.response-view-btn').forEach(btn => {
            btn.addEventListener('click', () => switchView(btn.id.replace('view-', '').replace('-btn', '')));
        });
        clearHistoryBtn.addEventListener('click', clearHistory);
        stopWebhookBtn.addEventListener('click', stopWebhook);
        
        enableWebhookSwitch.addEventListener('change', (e) => {
            isWebhookEnabled = e.target.checked;
        });
        
        newRequestBtn.addEventListener('click', () => {
            resetCurrentRequest();
            urlInput.value = '';
            requestTypeSelect.value = 'GET';
            headersList.innerHTML = '';
            createHeaderInput();
            bodyInput.value = '';
            jsonResponseView.textContent = 'Your API response will appear here...';
            delete jsonResponseView.dataset.highlighted;
            jsonResponseView.className = 'language-json p-4 rounded-lg text-sm';
            statusContainer.innerHTML = '';
            metricsContainer.innerHTML = '';
            extractJsonBtn.disabled = true;
            extractSearchAllToggle.disabled = true;
            extractSearchAllToggle.checked = false;
        });
        
        [urlInput, requestTypeSelect, bodyInput].forEach(el => el.addEventListener('input', resetCurrentRequest));
        headersList.addEventListener('input', resetCurrentRequest);
        
        bodyWrapToggle.addEventListener('change', (e) => {
            if (e.target.checked) {
                bodyInput.classList.add('whitespace-pre-wrap');
                bodyInput.classList.remove('whitespace-pre');
            } else {
                bodyInput.classList.remove('whitespace-pre-wrap');
                bodyInput.classList.add('whitespace-pre');
            }
        });
        
        extractPathsInput.addEventListener('input', updateExtractionResults);
        extractSearchAllToggle.addEventListener('change', updateExtractionResults);
        document.querySelectorAll('input[name="extract-format"]').forEach(radio => {
            radio.addEventListener('change', updateExtractionResults);
        });

        copyExtractResultsBtn.addEventListener('click', () => {
            const textToCopy = extractResultsOutput.textContent;
            const textArea = document.createElement("textarea");
            textArea.value = textToCopy;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                copyExtractResultsBtn.innerHTML = '<i class="fa-solid fa-check"></i> Copied!';
            } catch (err) {
                console.error('Failed to copy text: ', err);
            }
            document.body.removeChild(textArea);
            setTimeout(() => {
                copyExtractResultsBtn.innerHTML = '<i class="fa-solid fa-copy"></i> Copy';
            }, 2000);
        });

        clearExtractPathsBtn.addEventListener('click', () => {
            extractPathsInput.value = '';
            updateExtractionResults();
        });

        // --- Initial Load ---
        if (headersList.childElementCount === 0) createHeaderInput();
        renderHistory();
        hljs.highlightAll();
    });
    </script>
</body>
</html>
